# GitLab CI/CD Pipeline for Tax Free RDC Desktop App (Tauri)
# This pipeline builds the desktop application for Windows, macOS, and Linux

stages:
  - build
  - release

variables:
  CARGO_HOME: "$CI_PROJECT_DIR/.cargo"
  RUSTUP_HOME: "$CI_PROJECT_DIR/.rustup"

# Cache Rust and Node dependencies
.cache_template: &cache_template
  cache:
    key: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"
    paths:
      - frontend/node_modules/
      - frontend/src-tauri/target/
      - .cargo/
      - .rustup/

# Build for Windows
build:windows:
  stage: build
  tags:
    - windows
  <<: *cache_template
  before_script:
    - choco install nodejs-lts rust -y
    - refreshenv
    - cd frontend
    - npm ci
  script:
    - npm run tauri:build
  artifacts:
    name: "taxfree-rdc-windows-$CI_COMMIT_SHORT_SHA"
    paths:
      - frontend/src-tauri/target/release/bundle/nsis/*.exe
      - frontend/src-tauri/target/release/bundle/msi/*.msi
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
    - if: $CI_PIPELINE_SOURCE == "web"

# Build for macOS (Intel)
build:macos-intel:
  stage: build
  tags:
    - macos
    - x86_64
  <<: *cache_template
  before_script:
    - brew install node rust
    - cd frontend
    - npm ci
  script:
    - npm run tauri:build -- --target x86_64-apple-darwin
  artifacts:
    name: "taxfree-rdc-macos-intel-$CI_COMMIT_SHORT_SHA"
    paths:
      - frontend/src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg
      - frontend/src-tauri/target/x86_64-apple-darwin/release/bundle/macos/*.app
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
    - if: $CI_PIPELINE_SOURCE == "web"

# Build for macOS (Apple Silicon)
build:macos-arm:
  stage: build
  tags:
    - macos
    - arm64
  <<: *cache_template
  before_script:
    - brew install node rust
    - cd frontend
    - npm ci
  script:
    - npm run tauri:build -- --target aarch64-apple-darwin
  artifacts:
    name: "taxfree-rdc-macos-arm-$CI_COMMIT_SHORT_SHA"
    paths:
      - frontend/src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg
      - frontend/src-tauri/target/aarch64-apple-darwin/release/bundle/macos/*.app
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
    - if: $CI_PIPELINE_SOURCE == "web"

# Build for Linux
build:linux:
  stage: build
  image: rust:latest
  <<: *cache_template
  before_script:
    - apt-get update
    - apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf nodejs npm
    - cd frontend
    - npm ci
  script:
    - npm run tauri:build
  artifacts:
    name: "taxfree-rdc-linux-$CI_COMMIT_SHORT_SHA"
    paths:
      - frontend/src-tauri/target/release/bundle/appimage/*.AppImage
      - frontend/src-tauri/target/release/bundle/deb/*.deb
      - frontend/src-tauri/target/release/bundle/rpm/*.rpm
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
    - if: $CI_PIPELINE_SOURCE == "web"

# Create GitLab Release with all artifacts
release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: build:windows
      artifacts: true
    - job: build:macos-intel
      artifacts: true
    - job: build:macos-arm
      artifacts: true
    - job: build:linux
      artifacts: true
  script:
    - echo "Creating release for $CI_COMMIT_TAG"
  release:
    tag_name: $CI_COMMIT_TAG
    name: "Tax Free RDC $CI_COMMIT_TAG"
    description: |
      ## Tax Free RDC $CI_COMMIT_TAG
      
      ### Téléchargements
      
      | Plateforme | Fichier |
      |------------|---------|
      | **Windows** | `.exe` (installateur NSIS) ou `.msi` |
      | **macOS Intel** | `.dmg` |
      | **macOS Apple Silicon** | `.dmg` |
      | **Linux** | `.AppImage`, `.deb`, ou `.rpm` |
      
      ### Installation
      
      1. Téléchargez le fichier correspondant à votre système
      2. Exécutez l'installateur
      3. Suivez les instructions à l'écran
      
      ### Notes de version
      Consultez le CHANGELOG pour les détails des modifications.
    assets:
      links:
        - name: "Windows Installer (exe)"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/frontend/src-tauri/target/release/bundle/nsis/Tax%20Free%20RDC_${CI_COMMIT_TAG#v}_x64-setup.exe?job=build:windows"
        - name: "Windows Installer (msi)"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/frontend/src-tauri/target/release/bundle/msi/Tax%20Free%20RDC_${CI_COMMIT_TAG#v}_x64_en-US.msi?job=build:windows"
        - name: "macOS Intel (dmg)"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/frontend/src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/Tax%20Free%20RDC_${CI_COMMIT_TAG#v}_x64.dmg?job=build:macos-intel"
        - name: "macOS Apple Silicon (dmg)"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/frontend/src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/Tax%20Free%20RDC_${CI_COMMIT_TAG#v}_aarch64.dmg?job=build:macos-arm"
        - name: "Linux AppImage"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/frontend/src-tauri/target/release/bundle/appimage/tax-free-rdc_${CI_COMMIT_TAG#v}_amd64.AppImage?job=build:linux"
        - name: "Linux DEB"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/frontend/src-tauri/target/release/bundle/deb/tax-free-rdc_${CI_COMMIT_TAG#v}_amd64.deb?job=build:linux"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
